<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 450">
  <defs>
    <linearGradient id="stepGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1D4ED8;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stepGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7C3AED;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stepGrad3" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F97316;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#EA580C;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stepGrad4" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stepGrad5" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#EC4899;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#DB2777;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stepGrad6" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#06B6D4;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#0891B2;stop-opacity:1" />
    </linearGradient>
    <filter id="glow">
      <feDropShadow dx="0" dy="2" stdDeviation="4" flood-opacity="0.3"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="450" fill="#0f172a" rx="12"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" fill="white" font-family="system-ui" font-size="20" font-weight="600">Request Flow: TCP Connection Lifecycle</text>

  <!-- Step 1 -->
  <g filter="url(#glow)">
    <circle cx="80" cy="140" r="40" fill="url(#stepGrad1)"/>
    <text x="80" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">1</text>
    <text x="80" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">Accept</text>
  </g>
  <text x="80" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">TCP Accept</text>
  <text x="80" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">TcpListener</text>
  <text x="80" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">::accept()</text>

  <!-- Arrow 1-2 -->
  <path d="M 130 140 L 185 140" stroke="#475569" stroke-width="2.5" fill="none"/>
  <polygon points="195,140 183,133 183,147" fill="#475569"/>

  <!-- Step 2 -->
  <g filter="url(#glow)">
    <circle cx="235" cy="140" r="40" fill="url(#stepGrad2)"/>
    <text x="235" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">2</text>
    <text x="235" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">Binding</text>
  </g>
  <text x="235" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">Check Affinity</text>
  <text x="235" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">DashMap</text>
  <text x="235" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">lookup</text>

  <!-- Arrow 2-3 -->
  <path d="M 285 140 L 340 140" stroke="#475569" stroke-width="2.5" fill="none"/>
  <polygon points="350,140 338,133 338,147" fill="#475569"/>

  <!-- Step 3 -->
  <g filter="url(#glow)">
    <circle cx="390" cy="140" r="40" fill="url(#stepGrad3)"/>
    <text x="390" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">3</text>
    <text x="390" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">GeoIP</text>
  </g>
  <text x="390" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">Resolve Region</text>
  <text x="390" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">MaxMind</text>
  <text x="390" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">GeoLite2</text>

  <!-- Arrow 3-4 -->
  <path d="M 440 140 L 495 140" stroke="#475569" stroke-width="2.5" fill="none"/>
  <polygon points="505,140 493,133 493,147" fill="#475569"/>

  <!-- Step 4 -->
  <g filter="url(#glow)">
    <circle cx="545" cy="140" r="40" fill="url(#stepGrad4)"/>
    <text x="545" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">4</text>
    <text x="545" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">Score</text>
  </g>
  <text x="545" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">Select Backend</text>
  <text x="545" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">pick_backend()</text>
  <text x="545" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">lowest score</text>

  <!-- Arrow 4-5 -->
  <path d="M 595 140 L 650 140" stroke="#475569" stroke-width="2.5" fill="none"/>
  <polygon points="660,140 648,133 648,147" fill="#475569"/>

  <!-- Step 5 -->
  <g filter="url(#glow)">
    <circle cx="700" cy="140" r="40" fill="url(#stepGrad5)"/>
    <text x="700" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">5</text>
    <text x="700" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">Connect</text>
  </g>
  <text x="700" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">TCP Connect</text>
  <text x="700" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">WireGuard</text>
  <text x="700" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">10.50.x.x</text>

  <!-- Arrow 5-6 -->
  <path d="M 750 140 L 805 140" stroke="#475569" stroke-width="2.5" fill="none"/>
  <polygon points="815,140 803,133 803,147" fill="#475569"/>

  <!-- Step 6 -->
  <g filter="url(#glow)">
    <circle cx="855" cy="140" r="40" fill="url(#stepGrad6)"/>
    <text x="855" y="135" text-anchor="middle" fill="white" font-family="system-ui" font-size="22" font-weight="700">6</text>
    <text x="855" y="155" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="system-ui" font-size="9">Proxy</text>
  </g>
  <text x="855" y="200" text-anchor="middle" fill="white" font-family="system-ui" font-size="12" font-weight="500">Bidirectional</text>
  <text x="855" y="218" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">io::copy</text>
  <text x="855" y="234" text-anchor="middle" fill="#94A3B8" font-family="system-ui" font-size="10">zero-copy</text>

  <!-- Data Flow Detail Box -->
  <rect x="50" y="280" width="800" height="150" rx="8" fill="#1E293B" stroke="#334155"/>
  <text x="70" y="310" fill="white" font-family="system-ui" font-size="14" font-weight="500">Scoring Formula</text>

  <!-- Formula -->
  <rect x="70" y="325" width="350" height="40" rx="4" fill="#0F172A"/>
  <text x="85" y="352" fill="#3B82F6" font-family="monospace" font-size="13">score = region_score * 100 + (load / weight)</text>

  <!-- Scoring breakdown -->
  <g>
    <text x="450" y="335" fill="#94A3B8" font-family="system-ui" font-size="11">Region Score:</text>
    <rect x="540" y="322" width="15" height="15" rx="3" fill="#22C55E"/>
    <text x="560" y="334" fill="#94A3B8" font-family="system-ui" font-size="10">0 = client match</text>
    <rect x="660" y="322" width="15" height="15" rx="3" fill="#FBBF24"/>
    <text x="680" y="334" fill="#94A3B8" font-family="system-ui" font-size="10">1 = local POP</text>
    <rect x="770" y="322" width="15" height="15" rx="3" fill="#EF4444"/>
    <text x="790" y="334" fill="#94A3B8" font-family="system-ui" font-size="10">2 = fallback</text>
  </g>

  <!-- Example calculation -->
  <text x="70" y="390" fill="#94A3B8" font-family="system-ui" font-size="11">Example: Client from Brazil, Backend sa-node-1 (region=sa, weight=2, 30 conns, soft_limit=50)</text>
  <rect x="70" y="400" width="760" height="25" rx="4" fill="#0F172A"/>
  <text x="85" y="418" fill="#10B981" font-family="monospace" font-size="11">score = 0 * 100 + (30/50) / 2 = 0 + 0.3 = 0.3  (lowest wins)</text>
</svg>
